name: Release Deployment

on:
  release:
    types: [ published ]

concurrency:
  group: deploy-release
  cancel-in-progress: false

jobs:
  build-and-test:
    name: Build & Test Project
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout source code
        uses: actions/checkout@v6

      - name: Set Up Build Environment
        uses: ./.github/actions/setup-env

      - name: Run Build & Tests
        run: ./gradlew clean check --no-daemon

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  package-linux:
    name: Package Linux Installers
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6

      - name: Set Up Build Environment
        uses: ./.github/actions/setup-env

      - name: Build Linux installers
        run: ./gradlew packageLinux -x test --no-daemon

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: linux-installers
          path: |
            build/packager/*.deb
            build/packager/*.rpm

  package-windows:
    name: Package Windows Installer
    runs-on: windows-latest
    needs: build-and-test
    permissions:
      contents: read

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6

      - name: Set Up Build Environment
        uses: ./.github/actions/setup-env

      - name: Install Inno Setup
        run: choco install -y innosetup

      - name: Build Windows installer
        run: ./gradlew packageWindows -x test --no-daemon

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v5
        with:
          name: windows-installer
          path: build/packager/*.exe

  release:
    name: Publish Release Artifacts
    runs-on: ubuntu-latest
    needs: [ package-linux, package-windows ]
    permissions:
      contents: write

    steps:
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v7
        with:
          name: linux-installers
          path: dist/linux

      - name: Download Windows Artifact
        uses: actions/download-artifact@v7
        with:
          name: windows-installer
          path: dist/windows

      - name: Verify Release Artifacts
        run: ls -R dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/linux/**
            dist/windows/**
